name: Build ANGLE for Android

on:
  workflow_dispatch: # 手动触发
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        abi: [arm64, arm, x64]

    env:
      ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      ANDROID_NDK_ROOT: ${{ github.workspace }}/android-sdk/ndk/26.1.10909125

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git python3 curl unzip openjdk-11-jdk

      - name: Install depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $HOME/depot_tools
          echo "$HOME/depot_tools" >> $GITHUB_PATH

      - name: Install Android SDK & NDK
        run: |
          mkdir -p $ANDROID_SDK_ROOT
          cd $ANDROID_SDK_ROOT
          curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdline-tools.zip
          unzip -q cmdline-tools.zip
          mkdir -p cmdline-tools/latest
          mv cmdline-tools/* cmdline-tools/latest/
          rm cmdline-tools.zip
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT \
            "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;26.1.10909125"

      - name: Fetch ANGLE
        run: |
          mkdir -p $GITHUB_WORKSPACE/angle
          cd $GITHUB_WORKSPACE/angle
          fetch angle
          gclient sync

      - name: Build ANGLE (${{ matrix.abi }})
        run: |
          cd $GITHUB_WORKSPACE/angle
          case ${{ matrix.abi }} in
            arm64)
              TARGET_CPU=arm64
              ABI_DIR=arm64-v8a
              ;;
            arm)
              TARGET_CPU=arm
              ABI_DIR=armeabi-v7a
              ;;
            x64)
              TARGET_CPU=x64
              ABI_DIR=x86_64
              ;;
          esac

          OUT_DIR=out/Android_${{ matrix.abi }}
          gn gen $OUT_DIR --args="target_os=\"android\" target_cpu=\"$TARGET_CPU\" is_debug=false angle_enable_vulkan=true android_ndk_root=\"$ANDROID_NDK_ROOT\" android_sdk_root=\"$ANDROID_SDK_ROOT\" android_ndk_version=\"26\" android_sdk_version=34"
          autoninja -C $OUT_DIR libEGL libGLESv2

          mkdir -p artifacts/$ABI_DIR
          cp $OUT_DIR/libEGL_angle.so artifacts/$ABI_DIR/
          cp $OUT_DIR/libGLESv2_angle.so artifacts/$ABI_DIR/

      - name: Copy headers
        if: matrix.abi == 'arm64' # 只需要一次
        run: |
          mkdir -p artifacts/include
          cp -r $GITHUB_WORKSPACE/angle/include/* artifacts/include/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: angle-android-${{ matrix.abi }}
          path: artifacts
